package fr.mathis.tourhanoipro;

import java.util.Timer;
import java.util.TimerTask;

import android.annotation.SuppressLint;
import android.graphics.Color;
import android.graphics.drawable.ColorDrawable;
import android.os.Bundle;
import android.support.v4.view.ViewPager;
import android.support.v4.view.ViewPager.OnPageChangeListener;
import android.support.v7.app.ActionBarActivity;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.TextView;

import com.nineoldandroids.animation.ObjectAnimator;
import com.nineoldandroids.animation.ValueAnimator;

import fr.mathis.tourhanoipro.adapter.TutoPagerAdapter;
import fr.mathis.tourhanoipro.tools.Tools;
import fr.mathis.tourhanoipro.views.CustomPagerIndicator;

public class TutoActivity extends ActionBarActivity implements OnPageChangeListener {

	ViewPager pager;
	TextView tvStep;
	CustomPagerIndicator cpi;
	View vSwypeIndicator;
	ObjectAnimator alphaAnimator;
	ColorDrawable mBackgroundView;
	ColorDrawable mBackgroundContainerView;

	@SuppressWarnings("deprecation")
	@SuppressLint("NewApi")
	@Override
	protected void onCreate(Bundle savedInstanceState) {

		super.onCreate(savedInstanceState);

		setContentView(R.layout.activity_tuto);

		getSupportActionBar().hide();

		pager = (ViewPager) findViewById(R.id.tuto_pager);
		tvStep = (TextView) findViewById(R.id.tv_step);
		vSwypeIndicator = findViewById(R.id.v_swype_indicator);

		mBackgroundView = new ColorDrawable(getResources().getColor(R.color.ui_color));
		findViewById(R.id.topLevel).setBackgroundDrawable(mBackgroundView);

		mBackgroundContainerView = new ColorDrawable(Color.WHITE);
		findViewById(R.id.rl_indicator_container).setBackgroundDrawable(mBackgroundContainerView);

		TutoPagerAdapter pagerAdapter = new TutoPagerAdapter(getSupportFragmentManager());
		pager.setAdapter(pagerAdapter);
		pager.setPageMargin(Tools.convertDpToPixel(8));
		pager.setOnPageChangeListener(this);
		pager.setOffscreenPageLimit(5);

		tvStep.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				finish();
			}
		});

		cpi = (CustomPagerIndicator) findViewById(R.id.cpi_pager_indicator);

		alphaAnimator = ObjectAnimator.ofFloat(vSwypeIndicator, "alpha", 0.0f, 0.75f);
		alphaAnimator.setDuration(1000);
		alphaAnimator.setRepeatCount(ValueAnimator.INFINITE);
		alphaAnimator.setRepeatMode(ValueAnimator.REVERSE);
		alphaAnimator.start();
	}

	@Override
	public void onPageScrollStateChanged(int arg0) {

	}

	@Override
	public void onPageScrolled(int position, float positionOffset, int positionOffsetPixels) {

		cpi.updateBounds(position, TutoPagerAdapter.NB_STEPS, positionOffset);
	}

	@SuppressLint("NewApi")
	@Override
	public void onPageSelected(int pos) {
		if (alphaAnimator != null)
			alphaAnimator.cancel();

		if (position == 2) {
			mBackgroundView.setAlpha(0);
			mBackgroundContainerView.setAlpha(0);
		}

		if (pos + 1 == TutoPagerAdapter.NB_STEPS) {
			tvStep.setText(R.string.s52);

			Timer t = new Timer();
			t.schedule(new TimerTask() {

				@Override
				public void run() {
					runOnUiThread(new Runnable() {
						public void run() {
							finish();
							overridePendingTransition(R.anim.mainfadein, R.anim.tutofadeout);
						}
					});

				}
			}, 200);

		} else {
			tvStep.setText(R.string.s51);
		}
	}

	public void unloackHack(int id) {
		// if (isSignedIn()) {
		// getGamesClient().unlockAchievement(getString(id));
		// }
	}
}
